<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í† ìŠ¤í˜ì´ë¨¼ì¸  ê²°ì œ í…ŒìŠ¤íŠ¸ (ê²°ì œì°½ ë°©ì‹)</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
        }
        .container {
            border: 1px solid #ddd;
            padding: 20px;
            border-radius: 8px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
            font-size: 16px;
        }
        button:hover {
            background-color: #45a049;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 4px;
            display: none;
        }
        .success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .info {
            background-color: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
            margin-bottom: 20px;
            padding: 15px;
            border-radius: 4px;
        }
        code {
            background-color: #f4f4f4;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: monospace;
        }
    </style>
    <!-- í† ìŠ¤í˜ì´ë¨¼ì¸  ê²°ì œì°½ SDK ìŠ¤í¬ë¦½íŠ¸ -->
    <script src="https://js.tosspayments.com/v1/payment"></script>
</head>
<body>
    <div class="container">
        <h1>í† ìŠ¤í˜ì´ë¨¼ì¸  ê²°ì œ í…ŒìŠ¤íŠ¸ (ê²°ì œì°½ ë°©ì‹)</h1>
        
        <div class="info">
            <strong>âœ… API ê°œë³„ ì—°ë™ í‚¤ì˜ í´ë¼ì´ì–¸íŠ¸ í‚¤ ì‚¬ìš©</strong>
            <ul>
                <li><strong>ê²°ì œì°½ ë°©ì‹</strong>ì„ ì‚¬ìš©í•©ë‹ˆë‹¤ (ê²°ì œ ìœ„ì ¯ ì•„ë‹˜)</li>
                <li>í† ìŠ¤í˜ì´ë¨¼ì¸  ê°œë°œì ì„¼í„° â†’ <strong>ë‚´ í”„ë¡œì íŠ¸</strong> â†’ <strong>API í‚¤</strong> â†’ <strong>í´ë¼ì´ì–¸íŠ¸ í‚¤</strong> ì‚¬ìš©</li>
                <li>í…ŒìŠ¤íŠ¸ í™˜ê²½: <code>test_ck_</code>ë¡œ ì‹œì‘í•˜ëŠ” í‚¤</li>
                <li>SDK ë¡œë“œ ìƒíƒœ: <span id="scriptStatus">í™•ì¸ ì¤‘...</span></li>
            </ul>
            <hr style="margin: 10px 0;">
            <strong>ğŸ“‹ í…ŒìŠ¤íŠ¸ ì¹´ë“œ ì •ë³´:</strong>
            <ul style="margin-top: 5px;">
                <li>ì¹´ë“œ ë²ˆí˜¸: <code>1234-5678-9012-3456</code> (ë˜ëŠ” ì‹¤ì œ ì¹´ë“œ ë²ˆí˜¸ë„ ê°€ëŠ¥ - ì‹¤ì œ ê²°ì œ ì•ˆ ë¨)</li>
                <li>ìœ íš¨ê¸°ê°„: ì„ì˜ì˜ ë¯¸ë˜ ë‚ ì§œ (ì˜ˆ: 12/25)</li>
                <li>CVC: ì„ì˜ì˜ 3ìë¦¬ ìˆ«ì (ì˜ˆ: 123)</li>
                <li>ë¹„ë°€ë²ˆí˜¸: ì• 2ìë¦¬ (ì˜ˆ: 12)</li>
            </ul>
            <hr style="margin: 10px 0;">
            <strong>ğŸ’¡ ì°¸ê³ :</strong>
            <ul style="margin-top: 5px;">
                <li>í…ŒìŠ¤íŠ¸ í™˜ê²½ì—ì„œëŠ” ì‹¤ì œ ì¹´ë“œ ì •ë³´ë¥¼ ì…ë ¥í•´ë„ ì‹¤ì œ ê²°ì œê°€ ë°œìƒí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤</li>
                <li>ê²°ì œì°½ì´ íŒì—…ìœ¼ë¡œ ì—´ë¦½ë‹ˆë‹¤</li>
            </ul>
        </div>

        <form id="paymentForm">
            <div class="form-group">
                <label for="clientKey">Client Key (API ê°œë³„ ì—°ë™ í‚¤ì˜ í´ë¼ì´ì–¸íŠ¸ í‚¤):</label>
                <input type="text" id="clientKey" 
                       placeholder="test_ck_ë¡œ ì‹œì‘í•˜ëŠ” í‚¤ ì…ë ¥" 
                       value="" required>
                <small style="color: #666;">
                    ğŸ’¡ í† ìŠ¤í˜ì´ë¨¼ì¸  ê°œë°œì ì„¼í„° â†’ <strong>ë‚´ í”„ë¡œì íŠ¸</strong> â†’ <strong>API í‚¤</strong> â†’ <strong>í´ë¼ì´ì–¸íŠ¸ í‚¤</strong>ì—ì„œ í™•ì¸
                </small>
            </div>

            <div class="form-group">
                <label for="paymentMethod">ê²°ì œ ìˆ˜ë‹¨:</label>
                <select id="paymentMethod" required>
                    <option value="ì¹´ë“œ">ì¹´ë“œ</option>
                    <option value="ê°€ìƒê³„ì¢Œ">ê°€ìƒê³„ì¢Œ</option>
                    <option value="ê³„ì¢Œì´ì²´">ê³„ì¢Œì´ì²´</option>
                    <option value="íœ´ëŒ€í°">íœ´ëŒ€í°</option>
                </select>
            </div>

            <div class="form-group">
                <label for="amount">ê²°ì œ ê¸ˆì•¡:</label>
                <input type="number" id="amount" value="1000" min="1000" required>
            </div>

            <div class="form-group">
                <label for="orderId">ì£¼ë¬¸ ID:</label>
                <input type="text" id="orderId" 
                       value="test_order_" required>
            </div>

            <div class="form-group">
                <label for="orderName">ì£¼ë¬¸ëª…:</label>
                <input type="text" id="orderName" 
                       value="í…ŒìŠ¤íŠ¸ ê²°ì œ" required>
            </div>

            <div class="form-group">
                <label for="customerName">ê³ ê°ëª…:</label>
                <input type="text" id="customerName" 
                       value="í™ê¸¸ë™" required>
            </div>

            <button type="submit" id="submitButton">ê²°ì œí•˜ê¸°</button>
        </form>

        <div id="result" class="result"></div>
    </div>

    <script>
        const clientKeyInput = document.getElementById('clientKey');
        const paymentMethodInput = document.getElementById('paymentMethod');
        const amountInput = document.getElementById('amount');
        const orderIdInput = document.getElementById('orderId');
        const orderNameInput = document.getElementById('orderName');
        const customerNameInput = document.getElementById('customerName');
        const resultDiv = document.getElementById('result');
        const paymentForm = document.getElementById('paymentForm');
        const submitButton = document.getElementById('submitButton');

        // ì£¼ë¬¸ ID ìë™ ìƒì„±
        orderIdInput.value = 'test_order_' + Date.now();

        // í™˜ê²½ë³€ìˆ˜ì—ì„œ í´ë¼ì´ì–¸íŠ¸ í‚¤ ê°€ì ¸ì˜¤ê¸°
        async function loadClientKey() {
            try {
                const response = await fetch('/api/v1/payments/client-key');
                if (response.ok) {
                    const data = await response.json();
                    if (data.clientKey && data.clientKey.trim() !== '') {
                        clientKeyInput.value = data.clientKey;
                        console.log('[í´ë¼ì´ì–¸íŠ¸ í‚¤] í™˜ê²½ë³€ìˆ˜ì—ì„œ ë¡œë“œë¨');
                    } else {
                        console.log('[í´ë¼ì´ì–¸íŠ¸ í‚¤] í™˜ê²½ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì§€ ì•ŠìŒ');
                    }
                } else {
                    console.warn('[í´ë¼ì´ì–¸íŠ¸ í‚¤] API í˜¸ì¶œ ì‹¤íŒ¨:', response.status);
                }
            } catch (error) {
                console.warn('[í´ë¼ì´ì–¸íŠ¸ í‚¤] ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ í´ë¼ì´ì–¸íŠ¸ í‚¤ ë¡œë“œ
        window.addEventListener('load', function() {
            loadClientKey();
        });

        // SDK ë¡œë“œ í™•ì¸
        function checkSDKLoaded() {
            if (typeof TossPayments !== 'undefined') {
                document.getElementById('scriptStatus').innerHTML = '<span style="color: green;">âœ… ë¡œë“œ ì™„ë£Œ</span>';
                return true;
            } else {
                document.getElementById('scriptStatus').innerHTML = '<span style="color: red;">âŒ ë¡œë“œ ì‹¤íŒ¨</span>';
                return false;
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ SDK í™•ì¸
        window.addEventListener('load', function() {
            console.log('[SDK í™•ì¸] TossPayments íƒ€ì…:', typeof TossPayments);
            checkSDKLoaded();
        });

        paymentForm.addEventListener('submit', function(e) {
            e.preventDefault();

            const clientKey = clientKeyInput.value.trim();
            const paymentMethod = paymentMethodInput.value;
            const amount = parseInt(amountInput.value);
            const orderId = orderIdInput.value.trim();
            const orderName = orderNameInput.value.trim();
            const customerName = customerNameInput.value.trim();

            if (!clientKey) {
                showResult('error', 'âŒ Client Keyë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            // í‚¤ í˜•ì‹ ê²€ì¦
            if (!clientKey.startsWith('test_ck_') && !clientKey.startsWith('live_ck_')) {
                showResult('error', 
                    'âš ï¸ í‚¤ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.<br>' +
                    'í…ŒìŠ¤íŠ¸ í™˜ê²½: <code>test_ck_</code>ë¡œ ì‹œì‘í•´ì•¼ í•©ë‹ˆë‹¤.<br>' +
                    'ì‹¤ì œ í™˜ê²½: <code>live_ck_</code>ë¡œ ì‹œì‘í•´ì•¼ í•©ë‹ˆë‹¤.'
                );
                return;
            }

            if (amount < 1000) {
                showResult('error', 'âŒ ê²°ì œ ê¸ˆì•¡ì€ ìµœì†Œ 1,000ì› ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
                return;
            }

            // SDK ë¡œë“œ í™•ì¸
            if (typeof TossPayments === 'undefined') {
                showResult('error', 
                    'âŒ í† ìŠ¤í˜ì´ë¨¼ì¸  SDKê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.<br><br>' +
                    'ğŸ’¡ <strong>í•´ê²° ë°©ë²•:</strong><br>' +
                    '1. ë¸Œë¼ìš°ì € ì½˜ì†”(F12)ì—ì„œ ë„¤íŠ¸ì›Œí¬ íƒ­ í™•ì¸<br>' +
                    '2. https://js.tosspayments.com/v1/payment ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ í™•ì¸<br>' +
                    '3. ë„¤íŠ¸ì›Œí¬ ì—°ê²° ìƒíƒœ í™•ì¸<br>' +
                    '4. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ì„¸ìš”'
                );
                return;
            }

            // ê²°ì œ ë²„íŠ¼ ë¹„í™œì„±í™”
            submitButton.disabled = true;
            submitButton.textContent = 'ê²°ì œ ì²˜ë¦¬ ì¤‘...';

            try {
                console.log('[ê²°ì œ ìš”ì²­] ì‹œì‘ - orderId:', orderId, 'amount:', amount, 'paymentMethod:', paymentMethod);
                
                // í† ìŠ¤í˜ì´ë¨¼ì¸  ê²°ì œì°½ ê°ì²´ ìƒì„±
                const tossPayments = TossPayments(clientKey);

                // successUrlê³¼ failUrl ìƒì„± (í”Œë ˆì´ìŠ¤í™€ë” ì—†ì´ ì‹¤ì œ URL ì‚¬ìš©)
                const baseUrl = window.location.protocol + '//' + window.location.host;
                const successUrl = baseUrl + '/payment/success';
                const failUrl = baseUrl + '/payment/fail';
                
                console.log('[ê²°ì œ ìš”ì²­] successUrl:', successUrl);
                console.log('[ê²°ì œ ìš”ì²­] failUrl:', failUrl);

                // ê²°ì œ ìš”ì²­ (ê²°ì œì°½ì´ íŒì—…ìœ¼ë¡œ ì—´ë¦¼)
                tossPayments.requestPayment(paymentMethod, {
                    amount: amount,
                    orderId: orderId,
                    orderName: orderName,
                    customerName: customerName,
                    successUrl: successUrl,
                    failUrl: failUrl,
                }).then(function(data) {
                    // ê²°ì œ ì„±ê³µ ì‹œ (ì¼ë°˜ì ìœ¼ë¡œ successUrlë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ë˜ë¯€ë¡œ ì—¬ê¸° ë„ë‹¬í•˜ì§€ ì•Šì„ ìˆ˜ ìˆìŒ)
                    console.log('[ê²°ì œ ì„±ê³µ]', data);
                    submitButton.disabled = false;
                    submitButton.textContent = 'ê²°ì œí•˜ê¸°';
                    
                    showResult('success', 
                        'âœ… ê²°ì œ ì„±ê³µ!<br><br>' +
                        '<strong>Payment Key:</strong><br>' +
                        '<code style="word-break: break-all; display: block; padding: 10px; margin: 10px 0; background: #f8f9fa; border: 1px solid #dee2e6;">' + data.paymentKey + '</code><br>' +
                        '<strong>Order ID:</strong> ' + data.orderId + '<br><br>' +
                        '<hr>' +
                        '<h3>ë‹¤ìŒ ë‹¨ê³„: ë°±ì—”ë“œë¡œ ê²°ì œ ìŠ¹ì¸ ìš”ì²­</h3>' +
                        '<p>ë°›ì€ paymentKeyë¥¼ ë°±ì—”ë“œ APIë¡œ ì „ì†¡í•˜ì„¸ìš”:</p>' +
                        '<pre style="background: #f4f4f4; padding: 10px; border-radius: 4px; overflow-x: auto; font-size: 12px; margin: 10px 0;">' +
                        'POST http://localhost:8080/api/v1/payments/confirm\n' +
                        'Headers:\n' +
                        '  Authorization: Bearer {JWT_TOKEN}\n' +
                        '  Idempotency-Key: ' + crypto.randomUUID() + '\n' +
                        '  Content-Type: application/json\n' +
                        'Body:\n' +
                        '{\n' +
                        '  "paymentKey": "' + data.paymentKey + '",\n' +
                        '  "reservationId": 1\n' +
                        '}' +
                        '</pre>' +
                        '<button onclick="copyPaymentKey(\'' + data.paymentKey + '\')" style="margin-top: 10px; padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">ğŸ“‹ Payment Key ë³µì‚¬</button>'
                    );
                }).catch(function(error) {
                    console.error('[ê²°ì œ ì‹¤íŒ¨]', error);
                    submitButton.disabled = false;
                    submitButton.textContent = 'ê²°ì œí•˜ê¸°';
                    
                    if (error.code === 'USER_CANCEL') {
                        showResult('error', 
                            'âŒ ê²°ì œê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.<br><br>' +
                            'ì‚¬ìš©ìê°€ ê²°ì œì°½ì„ ë‹«ì•˜ìŠµë‹ˆë‹¤.'
                        );
                    } else {
                        showResult('error', 
                            'âŒ ê²°ì œ ì‹¤íŒ¨<br><br>' +
                            '<strong>ì—ëŸ¬ ë©”ì‹œì§€:</strong> ' + (error.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜') + '<br>' +
                            '<strong>ì—ëŸ¬ ì½”ë“œ:</strong> ' + (error.code || 'N/A') + '<br><br>' +
                            'ğŸ’¡ <strong>í•´ê²° ë°©ë²•:</strong><br>' +
                            '1. ë¸Œë¼ìš°ì € ì½˜ì†”(F12)ì—ì„œ ìì„¸í•œ ì—ëŸ¬ í™•ì¸<br>' +
                            '2. API ê°œë³„ ì—°ë™ í‚¤ì˜ í´ë¼ì´ì–¸íŠ¸ í‚¤ê°€ ì˜¬ë°”ë¥¸ì§€ í™•ì¸<br>' +
                            '3. í† ìŠ¤í˜ì´ë¨¼ì¸  ê°œë°œì ì„¼í„°ì—ì„œ ë„ë©”ì¸ ë“±ë¡ ì—¬ë¶€ í™•ì¸'
                        );
                    }
                });

            } catch (error) {
                console.error('[ê²°ì œ ìš”ì²­ ì‹¤íŒ¨]', error);
                submitButton.disabled = false;
                submitButton.textContent = 'ê²°ì œí•˜ê¸°';
                
                showResult('error', 
                    'âŒ ê²°ì œ ìš”ì²­ ì‹¤íŒ¨<br><br>' +
                    '<strong>ì—ëŸ¬ ë©”ì‹œì§€:</strong> ' + (error.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜') + '<br>' +
                    '<strong>ì—ëŸ¬ íƒ€ì…:</strong> ' + (error.name || 'N/A') + '<br><br>' +
                    'ğŸ’¡ <strong>í•´ê²° ë°©ë²•:</strong><br>' +
                    '1. ë¸Œë¼ìš°ì € ì½˜ì†”(F12)ì—ì„œ ìì„¸í•œ ì—ëŸ¬ í™•ì¸<br>' +
                    '2. API ê°œë³„ ì—°ë™ í‚¤ì˜ í´ë¼ì´ì–¸íŠ¸ í‚¤ê°€ ì˜¬ë°”ë¥¸ì§€ í™•ì¸<br>' +
                    '3. í† ìŠ¤í˜ì´ë¨¼ì¸  SDK ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ í™•ì¸'
                );
            }
        });

        function showResult(type, message) {
            resultDiv.className = 'result ' + type;
            resultDiv.innerHTML = message;
            resultDiv.style.display = 'block';
            resultDiv.scrollIntoView({ behavior: 'smooth' });
        }

        function copyPaymentKey(paymentKey) {
            navigator.clipboard.writeText(paymentKey).then(() => {
                alert('Payment Keyê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
            }).catch(err => {
                console.error('ë³µì‚¬ ì‹¤íŒ¨:', err);
                // Fallback: í…ìŠ¤íŠ¸ ì„ íƒ
                const textArea = document.createElement('textarea');
                textArea.value = paymentKey;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('Payment Keyê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
            });
        }
    </script>
</body>
</html>
